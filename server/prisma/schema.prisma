generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                @id @default(autoincrement())
  email               String             @unique
  name                String?
  role                UserRole           @default(TENANT)
  googleId            String?            @unique
  emailPinHash        String?
  emailPinExpiry      DateTime?
  isEmailVerified     Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  hashedPassword      String?
  maintenance         Maintenance[]
  payments            Payment[]
  properties          Property[]         @relation("LandlordProperties")
  tenanciesAsLandlord Tenancy[]          @relation("TenancyLandlord")
  tenanciesAsTenant   Tenancy[]          @relation("TenancyTenant")
  invitations         TenantInvitation[] @relation("LandlordInvitations")
}

model Property {
  id          Int                @id @default(autoincrement())
  landlordId  Int
  title       String
  description String?
  address     String
  monthlyRent Float
  status      PropertyStatus     @default(VACANT)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  maintenance Maintenance[]
  landlord    User               @relation("LandlordProperties", fields: [landlordId], references: [id])
  images      PropertyImage[]
  tenancies   Tenancy[]
  invitations TenantInvitation[]

  @@index([landlordId], map: "Property_landlordId_fkey")
}

model PropertyImage {
  id         Int      @id @default(autoincrement())
  propertyId Int
  url        String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id])

  @@index([propertyId], map: "PropertyImage_propertyId_fkey")
}

model Tenancy {
  id          Int       @id @default(autoincrement())
  propertyId  Int
  tenantId    Int
  landlordId  Int
  leaseStart  DateTime
  leaseEnd    DateTime
  monthlyRent Float
  createdAt   DateTime  @default(now())
  payments    Payment[]
  landlord    User      @relation("TenancyLandlord", fields: [landlordId], references: [id])
  property    Property  @relation(fields: [propertyId], references: [id])
  tenant      User      @relation("TenancyTenant", fields: [tenantId], references: [id])

  @@index([landlordId], map: "Tenancy_landlordId_fkey")
  @@index([propertyId], map: "Tenancy_propertyId_fkey")
  @@index([tenantId], map: "Tenancy_tenantId_fkey")
}

model Payment {
  id              Int           @id @default(autoincrement())
  tenancyId       Int?
  propertyId      Int?
  tenantId        Int
  amount          Float
  currency        String        @default("USD")
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?
  proofUrl        String?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  userId          Int?
  tenancy         Tenancy?      @relation(fields: [tenancyId], references: [id])
  tenant          User?         @relation(fields: [userId], references: [id])

  @@index([tenancyId], map: "Payment_tenancyId_fkey")
  @@index([userId], map: "Payment_userId_fkey")
}

model Maintenance {
  id          Int               @id @default(autoincrement())
  propertyId  Int
  tenantId    Int
  title       String
  description String?
  status      MaintenanceStatus @default(PENDING)
  photos      Json?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  property    Property          @relation(fields: [propertyId], references: [id])
  tenant      User              @relation(fields: [tenantId], references: [id])

  @@index([propertyId], map: "Maintenance_propertyId_fkey")
  @@index([tenantId], map: "Maintenance_tenantId_fkey")
}

model House {
  id       Int     @id
  name     String? @db.VarChar(45)
  location String? @db.VarChar(45)
}

model TenantInvitation {
  id            Int              @id @default(autoincrement())
  propertyId    Int
  landlordId    Int
  tenantEmail   String
  tenantName    String?
  leaseStart    DateTime
  leaseEnd      DateTime
  monthlyRent   Float
  depositAmount Float?
  token         String           @unique
  status        InvitationStatus @default(PENDING)
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  landlord      User             @relation("LandlordInvitations", fields: [landlordId], references: [id])
  property      Property         @relation(fields: [propertyId], references: [id])

  @@index([propertyId], map: "TenantInvitation_propertyId_fkey")
  @@index([landlordId], map: "TenantInvitation_landlordId_fkey")
  @@index([token])
}

enum UserRole {
  LANDLORD
  TENANT
}

enum PropertyStatus {
  VACANT
  OCCUPIED
}

enum PaymentMethod {
  STRIPE
  MANUAL
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}
